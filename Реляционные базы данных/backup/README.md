# Домашнее задание к занятию «Резервное копирование баз данных» - `Прыкин Сергей`

## Задание 1. Резервное копирование
Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.
Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

## Ответ

### 1.1. Восстановление данных в полном объёме за предыдущий день
Рекомендуемое решение: Полное ежедневное резервное копирование + инкрементальные/дифференциальные копии

Реализация:  
  Ежедневно в 23:00: Полное (full) резервное копирование всей БД  
  Каждый час: Инкрементальное (incremental) резервное копирование изменений  
  Стратегия хранения: Хранить полные бэкапы за последние 7-30 дней  

Преимущества:  
  Простота восстановления: Для восстановления на конец предыдущего дня нужен только один полный бэкап  
  Предсказуемость: Время восстановления известно и стабильно  
  Надёжность: Минимальная зависимость от цепочки инкрементальных копий  

Процесс восстановления:  
  Восстановить полный бэкап за предыдущий день  
  Применить все инкрементальные копии до требуемого времени (если нужно более точное время)  

### 1.2. Восстановление данных за час до предполагаемой поломки
Рекомендуемое решение: Комбинация полных, инкрементальных бэкапов + журналы транзакций (WAL)

Реализация:  
  Еженедельно: Полное резервное копирование  
  Ежедневно: Дифференциальное (differential) резервное копирование  
  Каждые 15-60 минут: Резервное копирование журналов транзакций (transaction log backup)  

Преимущества для Point-in-Time Recovery (PITR):  
  Точность: Можно восстановить состояние на любой момент времени  
  Минимальная потеря данных: RPO (Recovery Point Objective) ≈ 15-60 минут  
  Гибкость: Восстановление на конкретный timestamp  

Процесс восстановления:  
  Восстановить последний полный бэкап  
  Восстановить последний дифференциальный бэкап  
  Применить журналы транзакций до времени "за час до поломки" (например, до 13:00, если поломка в 14:00)  

### 1.3. Моментальное переключение при поломке базы
Да, возможен. Реализуется через High Availability (HA) и Disaster Recovery (DR) решения:

Решения для моментального переключения:
1. Database Replication с автоматическим failover:  
   Master-Slave репликация с синхронной репликацией  
   Автоматический мониторинг здоровья master-сервера  
   Automatic failover при обнаружении сбоя (переключение за 30-60 секунд)  
   Примеры: PostgreSQL HA с Patroni, MySQL Group Replication, SQL Server Always On  

2. Кластерные решения:  
   Active-Active кластер: Несколько узлов одновременно обрабатывают запросы  
   Shared-nothing архитектура: Каждый узел независим  
   Примеры: MySQL NDB Cluster, Galera Cluster для MySQL/MariaDB  

3. Cloud-native решения:  
   Управляемые БД в облаке с автоматическим failover  
   Multi-AZ развёртывание: Базы данных в разных зонах доступности  
   Примеры: AWS RDS Multi-AZ, Azure SQL Database, Google Cloud SQL HA  

Компоненты для автоматического переключения:  
Мониторинг здоровья:  
  Проверка доступности порта БД  
  Проверка ответа на SELECT 1  
  Мониторинг репликационного лага  

Менеджер кластера:  
  Примеры: Patroni, Pacemaker+Corosync, Kubernetes Operators  
  Автоматическое определение сбоя master  
  Продвижение slave в роль master  
  Обновление DNS/VIP  

Proxy/Load Balancer:  
  Автоматическое перенаправление трафика на новый master  
  Примеры: HAProxy, PgBouncer, ProxySQL  

Процесс автоматического переключения:  
 Обнаружение сбоя: Менеджер кластера определяет, что master недоступен  
 Проверка кандидатов: Выбор наиболее актуального slave (с минимальным лагом)  
 Promote slave: Перевод slave в режим master  
 Реконфигурация: Обновление точек входа (VIP, DNS)  
 Уведомление: Оповещение администраторов  
 Восстановление старого master: После починки - перевод в режим slave  

RTO/RPO для финансовой компании:  
  RTO (Recovery Time Objective): 1-5 минут для автоматического переключения  
  RPO (Recovery Point Objective):  
   Для синхронной репликации: 0 секунд (без потери данных)  
   Для асинхронной: от 0 до нескольких секунд  

---

## Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

## Ответ

### 2.1 Пример резервирования и восстановления БД
Резервирование (pg_dump)  
Для создания резервной копии всей базы данных в формате custom (сжатый, поддерживает селективное восстановление):  

	pg_dump -U username -F c -b -v -f /backup/mydb_backup.dump mydb  

-U username — пользователь БД  
-F c — формат custom (для pg_restore)  
-b — включать large objects  
-v — подробный вывод  
-f — файл для сохранения  
mydb — имя базы данных  

Восстановление (pg_restore)  
Восстановить в существующую БД (данные будут добавлены к существующим):  

	pg_restore -U username -d mydb -v /backup/mydb_backup.dump

Полное восстановление с пересозданием БД (если БД не существует):  
Сначала создать пустую БД  

	createdb -U username mydb  

Восстановить с опцией очистки  
	
	pg_restore -U username -d mydb -v --clean --create /backup/mydb_backup.dump

--clean — удалить существующие объекты перед восстановлением  
--create — создать БД из резервной копии  

### 2.1 Автоматизация процесса
Да, автоматизация возможна несколькими способами:  
  Скрипты + cron (Linux/macOS)  
  Использование pg_backrest или barman  
  Средства облачных провайдеров  
  Интеграция с CI/CD  

---

## Задание 3. MySQL
3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

### Ответ

3.1. Пример команды инкрементного резервного копирования в MySQL  
Для инкрементного резервного копирования в MySQL обычно используется утилита mysqlbinlog вместе с полным бэкапом.  
Пример последовательности команд:  
  Создание полного резервного копирования (например, в воскресенье):  

	mysqldump --all-databases --single-transaction --flush-logs --master-data=2 > full_backup.sql
  
  Параметры:  
   --single-transaction — обеспечивает консистентность данных для InnoDB.  
   --flush-logs — закрывает текущий бинарный лог и начинает новый.  
   --master-data=2 — записывает позицию бинарного лога в дамп.  

Создание инкрементного резервного копирования (например, в понедельник):  

	mysqlbinlog --start-position=<позиция_из_full_backup> binlog.000002 > inc_backup_mon.sql

Где <позиция_из_full_backup> — позиция из полного бэкапа, а binlog.000002 — файл бинарного лога, созданный после --flush-logs.

Восстановление:  
 Восстановить полный дамп: mysql < full_backup.sql  
 Применить инкрементный бэкап: mysql < inc_backup_mon.sql  

В MySQL 8.0+ можно использовать MySQL Enterprise Backup для автоматического инкрементного бэкапа, но в community-версии чаще используют связку mysqldump + mysqlbinlog.

### 3.1. Преимущества реплики по сравнению с обычным резервным копированием
Минимальный простой (High Availability):  
  Репликация позволяет быстро переключиться на резервный сервер при отказе основного, что критично для высокодоступных систем.  

Распределение нагрузки:  
  Реплики могут обслуживать запросы на чтение, разгружая основной сервер (например, для отчётов или аналитики).  

Географическая отказоустойчивость:  
  Реплики можно размещать в других дата-центрах, снижая риски при сбоях в одном регионе.  

"Горячее" резервное копирование:  
  Резервное копирование можно выполнять с реплики, не нагружая основной сервер.  

Тестирование обновлений:  
  На реплике можно тестировать обновления приложений или версий MySQL без риска для основного сервера.  

Ограничения репликации:  
  Не защищает от логических ошибок (например, DELETE без WHERE на основном сервере).  
  Требует мониторинга задержки репликации.  
  Не заменяет регулярные бэкапы (рекомендуется сочетать репликацию + резервное копирование).  

Репликация — это решение для высокой доступности и масштабирования, а резервное копирование — для восстановления данных после сбоев или ошибок. Их стоит использовать вместе.


