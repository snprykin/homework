# Домашнее задание к занятию «Репликация и масштабирование. Часть 2» - `Прыкин Сергей`

## Задание 1

Опишите основные преимущества использования масштабирования методами:

активный master-сервер и пассивный репликационный slave-сервер;
master-сервер и несколько slave-серверов;

### Активный master-сервер и пассивный репликационный slave-сервер

Основные преимущества:
 Повышение доступности и отказоустойчивости: При падении master-сервера slave может быть оперативно  
 переведён в роль master (failover), минимизируя время простоя системы.
 Резервное копирование без нагрузки на master: Резервные копии данных можно создавать с slave-сервера,  
 не затрагивая производительность основного сервера.
 Чтение данных без нагрузки на master: Запросы на чтение можно частично или полностью перенаправлять  
 на slave, разгружая master для операций записи.
 Простота архитектуры: Легче настроить и поддерживать по сравнению с кластерными решениями.

Ограничение: Slave-сервер в такой схеме обычно используется только для резервирования и чтения, но не для записи.

### Master-сервер и несколько slave-серверов

Основные преимущества:
 Масштабирование чтения: Нагрузка чтения распределяется между несколькими slave-серверами,  
 что позволяет обрабатывать больше запросов и снижать задержки для пользователей.
 Геораспределение: Slave-серверы можно размещать в разных регионах или дата-центрах,  
 чтобы данные были ближе к пользователям и повышалась общая надёжность системы.
 Гибкость использования: Разные slave-серверы можно специализировать под разные задачи  
 (например, аналитика, резервное копирование, обслуживание веб-приложений).
 Повышенная отказоустойчивость: При выходе из строя одного slave-сервера остальные продолжают  
 работать, система сохраняет функциональность для операций чтения.
 Возможность горизонтального масштабирования: По мере роста нагрузки можно добавлять новые  
 slave-серверы без остановки работы системы.

Ограничения:
 Запись по-прежнему возможна только на master, что создаёт потенциальное узкое место  
 (bottleneck) для операций записи.
 Может возникать задержка репликации (replication lag), из-за которой данные на  
 slave-серверах могут быть не полностью актуальными.


Оба подхода позволяют разделить операции чтения и записи, повышая производительность и надёжность системы.  
Первый вариант подходит для базовых сценариев с акцентом на резервирование, второй — для более высоких нагрузок  
на чтение и распределённых сценариев.  
Однако для масштабирования операций записи потребуются другие методы (например, шардирование).

---

## Задание 2
Разработайте план для выполнения горизонтального и вертикального шаринга базы данных.  
База данных состоит из трёх таблиц:
 пользователи,
 книги,
 магазины (столбцы произвольно).
Опишите принципы построения системы и их разграничение или разбивку между базами данных.
Пришлите блоксхему, где и что будет располагаться. Опишите, в каких режимах будут работать сервера.

### Ответ

Архитектурные принципы
1. Вертикальный шардинг (разделение по таблицам/доменам)
Принцип: Разделение таблиц по функциональным доменам на отдельные физические серверы/кластеры

Критерий разделения: Тип сущности и паттерны доступа

2. Горизонтальный шардинг (разделение по данным)
Принцип: Разделение строк одной таблицы между несколькими серверами

Критерии разделения:

Пользователи: по диапазону user_id (например, 1-1M, 1M-2M)

Книги: по жанру или году издания

Магазины: по географическому региону

Схема разбиения

                     ШАРДИРОВАННАЯ АРХИТЕКТУРА                   

                                                                 
   ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐
   │  Gateway /      │    │  Конфигуратор   │    │  Мониторинг  │
   │  Router         │◄──►│  шардов         │◄──►│ и            │
   │                 │    │  (Shard Map)    │    │  балансировка│
   └────────┬────────┘    └─────────────────┘    └──────────────┘
            │                                                    
            ▼                                                    
   ┌──────────────────────────────────────────────────────┐      
   │              ВЕРТИКАЛЬНОЕ РАЗДЕЛЕНИЕ                 │      
   │        (разные типы данных на разные серверы)        │      
   └──────────────────────────────────────────────────────┘      
                                                                 
   ┌──────────── ─┐  ┌─────────────┐  ┌──────────────┐           
   │  Кластер     │  │  Кластер    │  │  Кластер     │           
   │  ПОЛЬЗОВАТЕЛИ│  │  КНИГИ      │  │  МАГАЗИНЫ    │           
   │              │  │             │  │              │           
   └──────┬────── ┘  └──────┬──────┘  └──────┬───────┘           
          │                 │                │                   
          ▼                 ▼                ▼                   
   ┌──────────── ─┐  ┌───────────── ┐  ┌──────────────┐          
   │ГОРИЗОНТАЛЬНОЕ│  │ГОРИЗОНТАЛЬНОЕ│  │ГОРИЗОНТАЛЬНОЕ│          
   │ РАЗДЕЛЕНИЕ   │  │ РАЗДЕЛЕНИЕ   │  │ РАЗДЕЛЕНИЕ   │          
   └───────────── ┘  └───────────── ┘  └──────────────┘          
          │                │                │                    
   ┌──────┴──────┐  ┌──────┴──────┐  ┌──────┴───────┐            
   │ Шард U1     │  │ Шард B1     │  │ Шард S1      │            
   │ (user_id    │  │ (жанр:      │  │ (регион:     │            
   │  1-500k)    │  │  фантастика)│  │  Европа)     │            
   ├─────────────┤  ├─────────────┤  ├──────────────┤            
   │ Шард U2     │  │ Шард B2     │  │ Шард S2      │            
   │ (user_id    │  │ (жанр:      │  │ (регион:     │            
   │  500k-1M)   │  │  детективы) │  │  Азия)       │            
   ├─────────────┤  ├─────────────┤  ├──────────────┤            
   │ Шард U3     │  │ Шард B3     │  │ Шард S3      │       
   │ (user_id    │  │ (жанр:      │  │ (регион:     │       
   │  1M-1.5M)   │  │  nonfiction)│  │  Америка)    │       
   └─────────────┘  └─────────────┘  └──────────────┘       
                                                           
### Детализация разбиения
1. Кластер "Пользователи" (вертикальный шард)
Таблицы:
 users (основная информация)
 user_profiles (дополнительные данные)
 user_sessions
 user_preferences
Горизонтальный шардинг:
 Шард U1: user_id 1-500,000
 Шард U2: user_id 500,001-1,000,000
 Шард U3: user_id 1,000,001-1,500,000
Ключ шардинга: user_id

2. Кластер "Книги" (вертикальный шард)
Таблицы:
 books (информация о книгах)
 authors
 genres
 book_reviews
Горизонтальный шардинг:
 Шард B1: Жанр = 'Фантастика', 'Фэнтези'
 Шард B2: Жанр = 'Детективы', 'Триллеры'
 Шард B3: Жанр = 'Non-fiction', 'Наука', 'Образование'
 Ключ шардинга: genre_id

3. Кластер "Магазины" (вертикальный шард)
Таблицы:
 stores (информация о магазинах)
 store_inventory (наличие книг)
 orders
 shipments
Горизонтальный шардинг:
 Шард S1: Регион = 'Европа'
 Шард S2: Регион = 'Азия'
 Шард S3: Регион = 'Америка'
 Ключ шардинга: region_code

### Режимы работы серверов
1. Gateway/Router (Прокси-сервер)
Режим: Активный-активный
Роль: Принимает все запросы, определяет целевой шард
Балансировка: Round-robin между экземплярами

2. Конфигуратор шардов (Shard Map Manager)
Режим: Активный-пассивный (с репликацией)
Роль: Хранит карту распределения данных по шардам
Данные: Соответствие ключей шардинга → физическим серверам

3. Шарды данных (каждый кластер)

Шард Xn:
    ┌─────────────┐
    │   Master    │ ← Активный (чтение/запись)
    │  (primary)  │
    └──────┬──────┘
           │ Синхронная репликация
    ┌──────┴──────┐
    │   Slave 1   │ ← Пассивный (только чтение, hot standby)
    │   (sync)    │
    └──────┬──────┘
           │ Асинхронная репликация
    ┌──────┴──────┐
    │   Slave 2   │ ← Пассивный (только чтение, backup)
    │   (async)   │
    └─────────────┘

4. Сервис мониторинга и балансировки
Режим: Активный-активный
Функции:
 Мониторинг нагрузки на шарды
 Автоматическое перераспределение данных при дисбалансе
 Отслеживание репликационных лагов

### Принципы маршрутизации запросов
Запросы на чтение:
 Определяется целевой вертикальный шард (по типу таблицы)
 Определяется горизонтальный шард (по ключу шардинга)
 Запрос направляется на slave-реплику соответствующего шарда

Запросы на запись:
 Аналогичное определение шарда
 Запрос направляется на master-сервер соответствующего шарда
 При распределенных транзакциях используется 2PC (Two-Phase Commit)

Межшардовые запросы:
 Gateway собирает данные с нескольких шардов
 Агрегация выполняется на стороне приложения или в отдельном сервисе

### Стратегия репликации
Внутришардовая репликация:
 Master → Slave1: синхронная (для обеспечения consistency)
 Master → Slave2: асинхронная (для отложенного чтения/бэкапов)

Межшардовая синхронизация:
 Только через шард-маппер
 Референциальная целостность на уровне приложения

### Преимущества данной архитектуры
Вертикальное разделение:
 Изоляция разных типов данных
 Возможность оптимизации под конкретный тип нагрузки
 Независимое масштабирование

Горизонтальное разделение:
 Распределение нагрузки внутри домена
 Возможность географического распределения
 Линейное масштабирование при росте данных
 
Комбинированный подход:
 Максимальная гибкость
 Высокая доступность и отказоустойчивость
 Эффективное использование ресурсов

![1](https://github.com/snprykin/homework/blob/main/%D0%A0%D0%B5%D0%BB%D1%8F%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%B1%D0%B0%D0%B7%D1%8B%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85/replic_part1/screenshots/1.png)

![Ответ](https://github.com/snprykin/homework/blob/main/%D0%A0%D0%B5%D0%BB%D1%8F%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%B1%D0%B0%D0%B7%D1%8B%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85/replic_part1/screenshots/2.png)

![Ответ](https://github.com/snprykin/homework/blob/main/%D0%A0%D0%B5%D0%BB%D1%8F%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%B1%D0%B0%D0%B7%D1%8B%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85/replic_part1/screenshots/3.png)

![Ответ](https://github.com/snprykin/homework/blob/main/%D0%A0%D0%B5%D0%BB%D1%8F%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%B1%D0%B0%D0%B7%D1%8B%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85/replic_part1/screenshots/4.png)

![Ответ](https://github.com/snprykin/homework/blob/main/%D0%A0%D0%B5%D0%BB%D1%8F%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%B1%D0%B0%D0%B7%D1%8B%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85/replic_part1/screenshots/5.png)

![Ответ](https://github.com/snprykin/homework/blob/main/%D0%A0%D0%B5%D0%BB%D1%8F%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%B1%D0%B0%D0%B7%D1%8B%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85/replic_part1/screenshots/6.png)

![Ответ](https://github.com/snprykin/homework/blob/main/%D0%A0%D0%B5%D0%BB%D1%8F%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%B1%D0%B0%D0%B7%D1%8B%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85/replic_part1/screenshots/7.png)

![Ответ](https://github.com/snprykin/homework/blob/main/%D0%A0%D0%B5%D0%BB%D1%8F%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%B1%D0%B0%D0%B7%D1%8B%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85/replic_part1/screenshots/8.png)

![Ответ](https://github.com/snprykin/homework/blob/main/%D0%A0%D0%B5%D0%BB%D1%8F%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%B1%D0%B0%D0%B7%D1%8B%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85/replic_part1/screenshots/9.png)



